---
title: Practice of Koa with Typescript - Part 2
date: '2023-01-05'
tags: ['koa', 'typescript', 'backend', 'nodejs', 'jest', 'test', 'multi-process', 'jwt', 'cluster']
draft: true
summary: æœ€è¿‘é—²æ¥æ— äº‹ï¼Œäºæ˜¯å†³å®šå¯¹ Koa æ¡†æ¶è¿›è¡Œç®€å•çš„ç†Ÿæ‚‰ï¼Œå¹¶äº†è§£å’Œä½¿ç”¨ä¸€äº›åŒ…ã€‚æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•å¼•å…¥ jwt å¹¶ ä»¥ TDD çš„æ–¹å¼å®ç°ç™»é™†æ³¨å†ŒåŠŸèƒ½ï¼Œå¹¶é€šè¿‡ cluster è¿›è¡Œæ€§èƒ½è°ƒä¼˜ã€‚
canonicalUrl:
---

æœ¬æ–‡åœ¨ [å‰æ–‡](/blog/practice-of-koa-with-typescript-part1) åŸºç¡€ä¸Šç»§ç»­å®Œå–„ï¼Œå¼•å…¥ jest ä½œä¸ºæµ‹è¯•æ¡†æ¶ï¼Œå¹¶ä½¿ç”¨ JWTï¼ˆJson Web Tokenï¼‰ä»¥ TDDï¼ˆTest Driven Developmentï¼‰çš„æ–¹å¼å®ç°ç”¨æˆ·çš„æ³¨å†Œå’Œç™»å½•åŠŸèƒ½ï¼ŒåŒæ—¶è¿›è¡Œæ€§èƒ½æµ‹è¯•å’Œè°ƒä¼˜ã€‚åŒæ ·çš„ï¼Œç®€å•ä»‹ç»æœ¬æ–‡ä½¿ç”¨åˆ°çš„å·¥å…·ã€åŒ…å’Œæ¡†æ¶ï¼š

- jest & supertest & te-jest
- koa-bodyparser
- koa-jwt & jsonwebtoken

## Steps

### Â§1-æµ‹è¯•ç¯å¢ƒçš„æ­å»º

1. å®‰è£…ä¾èµ–ï¼š`pnpm add -D jest @types/jest ts-jest supertest`

2. åˆ›å»º jest é…ç½®æ–‡ä»¶ï¼Œæ‰§è¡Œ `pnpm jest --init`ï¼Œä¸‹é¢æ˜¯æˆ‘çš„é€‰æ‹©ï¼š

   ```bash
   The following questions will help Jest to create a suitable configuration for your project

   âœ” Would you like to use Jest when running "test" script in "package.json"? â€¦ yes
   âœ” Would you like to use Typescript for the configuration file? â€¦ yes
   âœ” Choose the test environment that will be used for testing â€º node
   âœ” Do you want Jest to add coverage reports? â€¦ yes
   âœ” Which provider should be used to instrument code for coverage? â€º v8
   âœ” Automatically clear mock calls, instances, contexts and results before every test? â€¦ yes

   âœï¸  Modified /Users/jasonlam/VscodeProjects/koa-example/package.json

   ğŸ“  Configuration file created at /Users/jasonlam/VscodeProjects/koa-example/jest.config.ts
   ```

3. ä¿®æ”¹ jest.config.tsï¼š

   ```typescript
   export default {
     clearMocks: true,
     collectCoverage: true,
     coverageDirectory: 'coverage',
     coverageProvider: 'v8',
     preset: 'ts-jest',
     testEnvironment: 'node',
   }
   ```

4. ä¿®æ”¹ package.jsonï¼š

   ```json
   ...
     "scripts": {
         "dev": "cross-env NODE_ENV=development tsnd --respawn src/server.ts",
         "test": "cross-env NODE_ENV=test jest --detectOpenHandles"
       }
   ...
   ```

5. åˆ›å»ºç¬¬ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ tests/server.test.tsï¼š

   ```typescript
   import mongoose from 'mongoose'
   import app from '../src/app'
   import config from '../src/config'

   const mockListen = jest.fn()
   app.listen = mockListen

   afterEach(async () => {
     mockListen.mockReset()
     await mongoose.connection.close()
   })

   test('Server works', async () => {
     require('../src/server')
     expect(mockListen.mock.calls.length).toBe(1)
     expect(mockListen.mock.calls[0][0]).toBe(config.server.port)
   })
   ```

6. æ‰§è¡Œ `pnpm test` æ¥è¿è¡Œæµ‹è¯•ï¼š

   ```bash
   âœ  koa-example git:(main) âœ— pnpm test
   > koa-example@1.0.0 test /Users/jasonlam/VscodeProjects/koa-example
   > jest

   (node:79731) [MONGOOSE] DeprecationWarning: Mongoose: the `strictQuery` option will be switched back to `false` by default i
   n Mongoose 7. Use `mongoose.set('strictQuery', false);` if you want to prepare for this change. Or use `mongoose.set('strictQuery', true);` to suppress this warning.                                                                                   (Use `node --trace-deprecation ...` to show where the warning was created)
   {"level":30,"time":1673084874708,"pid":79731,"hostname":"MacBook-Air.lan","msg":"Mongo connected"}
   {"level":30,"time":1673084874714,"pid":79731,"hostname":"MacBook-Air.lan","msg":"Mongo disconnected"}
    PASS  tests/server.test.ts
     âœ“ Server works (587 ms)

   -----------------|---------|----------|---------|---------|-------------------
   File             | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
   -----------------|---------|----------|---------|---------|-------------------
   All files        |   89.79 |    66.66 |     100 |   89.79 |
    src             |   85.71 |      100 |     100 |   85.71 |
     app.ts         |   89.47 |      100 |     100 |   89.47 | 15-16
     server.ts      |   83.78 |      100 |     100 |   83.78 | 16,23,30-31,35-36
    src/config      |     100 |        0 |     100 |     100 |
     index.ts       |     100 |        0 |     100 |     100 | 9
    src/routes      |     100 |      100 |     100 |     100 |
     index.ts       |     100 |      100 |     100 |     100 |
    src/routes/auth |   85.71 |      100 |     100 |   85.71 |
     index.ts       |   85.71 |      100 |     100 |   85.71 | 10-11
   -----------------|---------|----------|---------|---------|-------------------
   Test Suites: 1 passed, 1 total
   Tests:       1 passed, 1 total
   Snapshots:   0 total
   Time:        1.861 s
   Ran all test suites.
   ```

â€‹ è¿™æ ·ï¼ŒåŸºäº TS å’Œ Jest çš„æµ‹è¯•ç¯å¢ƒå°±æ­å»ºå®Œæˆäº†ï¼Œå¹¶ä¸”æˆåŠŸè·‘äº†ä¸€ä¸ªæµ‹è¯•

### Â§2-TDD å®è·µâ€”â€”æ³¨å†Œç™»å½•åŠŸèƒ½çš„å¼€å‘
